<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ­©æ•°è‚²æˆã‚¢ãƒ—ãƒª</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }

    label, input { margin: 5px 0; display: block; }

    canvas {
        width: 100% !important;
        max-width: 900px;
        margin-top: 20px;
        display: block;
        margin-left: auto;
        margin-right: auto;
    }

    .character {
        margin-top: 20px;
        text-align: center;
    }

    .character img {
        width: 150px;
        height: auto;
    }
    </style>
</head>
<body>

  <h1>æ­©æ•°è‚²æˆã‚¢ãƒ—ãƒª</h1>

  <form id="stepForm">
    <label for="date">æ—¥ä»˜:</label>
    <input type="date" id="date" required>

    <label for="steps">æ­©æ•°:</label>
    <input type="number" id="steps" required min="0">

    <button type="submit">ä¿å­˜</button>
  </form>

  <canvas id="stepChart"></canvas>

  <div class="character">
    <p id="recentTotal">ç›´è¿‘7æ—¥é–“ã®åˆè¨ˆæ­©æ•°: - æ­©</p> <!-- â† è¿½åŠ  -->
    <h2 id="charLevel">ãƒ¬ãƒ™ãƒ«: -</h2>
    <img id="charImage" src="" alt="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼">
    <p id="charMessage">æ­©ã„ã¦ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’è‚²ã¦ã‚ˆã†ï¼</p>
  </div>

  <script>
    const form = document.getElementById('stepForm');
    const chartCanvas = document.getElementById('stepChart');
    let stepData = loadData();
    let chart = null;

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const date = document.getElementById('date').value;
      const steps = parseInt(document.getElementById('steps').value);
      if (!date || isNaN(steps)) return;

      stepData[date] = steps;
      saveData(stepData);
      updateChart();
      updateCharacter();
      form.reset();
    });

    function saveData(data) {
      localStorage.setItem('stepData', JSON.stringify(data));
    }

    function loadData() {
      const saved = localStorage.getItem('stepData');
      return saved ? JSON.parse(saved) : {};
    }

    function getTotalSteps() {
      return Object.values(stepData).reduce((sum, steps) => sum + steps, 0);
    }

    function updateChart() {
      const dates = Object.keys(stepData).sort();
      const steps = dates.map(d => stepData[d]);

      if (chart) chart.destroy();

      chart = new Chart(chartCanvas, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: 'æ­©æ•°',
            data: steps,
            borderColor: 'blue',
            backgroundColor: 'lightblue',
            fill: true,
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function getRecent7DaysSteps() {
        const today = new Date();
        const recent7 = [];

        for (let i = 0; i < 7; i++) {
            const d = new Date(today);
            d.setDate(today.getDate() - i);
            const dateStr = d.toISOString().split('T')[0];
            recent7.push(dateStr);
        }

        return recent7.reduce((sum, date) => {
            return sum + (stepData[date] || 0);
        }, 0);
    }


    function updateCharacter() {
      const total = getTotalSteps();
      const levelEl = document.getElementById('charLevel');
      const messageEl = document.getElementById('charMessage');
      const imgEl = document.getElementById('charImage');
      const recentTotalEl = document.getElementById('recentTotal'); // â† è¿½åŠ 

  // ç›´è¿‘7æ—¥é–“ã®æ­©æ•°è¡¨ç¤º
      recentTotalEl.textContent = `ç›´è¿‘7æ—¥é–“ã®åˆè¨ˆæ­©æ•°: ${recentTotal} æ­©`;

      let level = 1;
      let message = 'ãŒã‚“ã°ã£ã¦æ­©ã“ã†ï¼';
      let image = './golden_egg.png';

      if (total >= 10000) {
        level = 5;
        message = 'æœ€çµ‚é€²åŒ–ï¼ã™ã”ã„ï¼';
        image = './fantasy_unicorn_rainbow.png';
      } else if (total >= 5000) {
        level = 4;
        message = 'ã©ã‚“ã©ã‚“å¼·ããªã£ã¦ããŸï¼';
        image = './animal_horse_thoroughbred_white.png';
      }else if (total >= 3000) {
        level = 3;
        message = 'ã‹ãªã‚Šæ­©ã„ãŸã­ï¼';
        image = './animal_uma_kodomo.png';
      } else if (total >= 1000) {
        level = 2;
        message = 'æˆé•·ã—ã¦ããŸã‚ˆï¼';
        image = './animal_komimi_tobinezumi.png';
      }

       // ğŸ”½ ç›´è¿‘7æ—¥é–“ã®åˆè¨ˆæ­©æ•°ã‚’ãƒã‚§ãƒƒã‚¯
        const recentTotal = getRecent7DaysSteps();
        if (recentTotal <= 1000) {
        message = 'æ®‹å¿µâ€¦ã‚‚ã£ã¨æ­©ã“ã†ï¼';
        image = './shirokuma_sleep.png';
        }

      levelEl.textContent = `ãƒ¬ãƒ™ãƒ«: ${level}`;
      messageEl.textContent = message;
      imgEl.src = image;
      imgEl.alt = `ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ ãƒ¬ãƒ™ãƒ«${level}`;
    }

    // åˆæœŸè¡¨ç¤º
    updateChart();
    updateCharacter();
  </script>

</body>
</html>
